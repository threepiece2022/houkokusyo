<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="å ±å‘Šæ›¸ä½œæˆ">
  <title>è¨ªå•çœ‹è­·å ±å‘Šæ›¸ä½œæˆãƒ„ãƒ¼ãƒ«</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
      padding: 16px;
      padding-bottom: 100px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 24px;
      padding-top: 8px;
    }
    
    .logo {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      border-radius: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 12px;
      box-shadow: 0 4px 16px rgba(59,130,246,0.3);
    }
    
    h1 {
      font-size: 22px;
      font-weight: 700;
      color: #1e293b;
      margin: 0 0 4px 0;
    }
    
    .subtitle {
      font-size: 13px;
      color: #64748b;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: #1e293b;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    @media (max-width: 500px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .form-group {
      margin-bottom: 0;
    }
    
    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 6px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      font-family: inherit;
      transition: all 0.2s;
      -webkit-appearance: none;
      appearance: none;
      background: white;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }
    
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
    }
    
    textarea {
      min-height: 160px;
      resize: vertical;
      line-height: 1.6;
    }
    
    .upload-zone {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #f8fafc;
    }
    
    .upload-zone:active {
      background: #f1f5f9;
      border-color: #8b5cf6;
    }
    
    .upload-zone .upload-icon {
      font-size: 36px;
      margin-bottom: 8px;
    }
    
    .upload-zone p {
      margin: 0;
      color: #64748b;
      font-size: 14px;
    }
    
    .upload-zone .upload-hint {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 4px;
    }
    
    .image-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    
    .image-thumb {
      position: relative;
      width: 70px;
      height: 70px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .image-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .image-thumb-remove {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 22px;
      height: 22px;
      background: rgba(0,0,0,0.6);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn {
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      width: 100%;
    }
    
    .btn-primary:active {
      transform: scale(0.98);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
    }
    
    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      padding: 10px 16px;
      font-size: 14px;
    }
    
    .btn-notion {
      background: #000;
      color: white;
      flex: 1;
    }
    
    .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .result-box {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border: 2px solid #86efac;
      border-radius: 12px;
      padding: 16px;
      white-space: pre-wrap;
      line-height: 1.7;
      font-size: 14px;
      color: #166534;
    }
    
    .alert {
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .alert-error {
      background: #fef2f2;
      border: 2px solid #fca5a5;
      color: #dc2626;
    }
    
    .alert-success {
      background: #f0fdf4;
      border: 2px solid #86efac;
      color: #16a34a;
    }
    
    .loading-spinner {
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .extracting-spinner {
      width: 28px;
      height: 28px;
      border: 3px solid rgba(139,92,246,0.2);
      border-top-color: #8b5cf6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 8px;
    }
    
    .settings-btn {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: white;
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      font-size: 20px;
      cursor: pointer;
      z-index: 100;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 200;
      display: none;
    }
    
    .modal-overlay.show {
      display: block;
    }
    
    .modal {
      position: fixed;
      top: 0;
      right: 0;
      width: 100%;
      max-width: 400px;
      height: 100%;
      background: white;
      z-index: 201;
      padding: 20px;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .modal.show {
      transform: translateX(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      margin: 0;
      font-size: 18px;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
    }
    
    .help-text {
      font-size: 12px;
      color: #64748b;
      margin-top: 6px;
    }
    
    .note {
      font-size: 12px;
      color: #64748b;
      text-align: center;
      margin-top: 12px;
    }
    
    .status-ok {
      color: #16a34a;
      font-weight: 600;
    }
    
    .status-ng {
      color: #dc2626;
      font-weight: 600;
    }
    
    footer {
      text-align: center;
      color: #94a3b8;
      font-size: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e2e8f0;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
  
  <div class="modal-overlay" id="modalOverlay" onclick="toggleSettings()"></div>
  <div class="modal" id="settingsModal">
    <div class="modal-header">
      <h2>âš™ï¸ è¨­å®š</h2>
      <button class="modal-close" onclick="toggleSettings()">âœ•</button>
    </div>
    <div class="form-group" style="margin-bottom: 16px;">
      <label>Google Apps Script URL</label>
      <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/..." oninput="saveSettings()">
      <p class="help-text">ç®¡ç†è€…ã‹ã‚‰å…±æœ‰ã•ã‚ŒãŸURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
    </div>
    <button class="btn btn-secondary" onclick="testConnection()" style="width: 100%;">ğŸ”— æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
    <p id="connectionStatus" style="text-align: center; margin-top: 12px;"></p>
  </div>

  <div class="container">
    <header>
      <div class="logo">ğŸ“‹</div>
      <h1>è¨ªå•çœ‹è­·å ±å‘Šæ›¸ä½œæˆ</h1>
      <p class="subtitle">çœ‹è­·å¸«ãƒ»ãƒªãƒãƒ“ãƒªè·å¯¾å¿œ</p>
    </header>
    
    <div id="errorAlert" class="alert alert-error hidden"></div>
    <div id="successAlert" class="alert alert-success hidden"></div>
    
    <div class="card">
      <h2 class="section-title">
        <span class="icon" style="background: #dbeafe; color: #3b82f6;">ğŸ‘¤</span>
        åŸºæœ¬æƒ…å ±
      </h2>
      <div class="form-grid">
        <div class="form-group">
          <label>å ±å‘Šæœˆ</label>
          <input type="month" id="reportMonth">
        </div>
        <div class="form-group">
          <label>æ‚£è€…æ°å</label>
          <input type="text" id="patientName" placeholder="å±±ç”° å¤ªéƒ">
        </div>
        <div class="form-group">
          <label>ä½œæˆè€…è·ç¨®</label>
          <select id="staffType" onchange="updatePlaceholder()">
            <option value="çœ‹è­·å¸«">çœ‹è­·å¸«</option>
            <option value="ç†å­¦ç™‚æ³•å£«">ç†å­¦ç™‚æ³•å£«ï¼ˆPTï¼‰</option>
            <option value="ä½œæ¥­ç™‚æ³•å£«">ä½œæ¥­ç™‚æ³•å£«ï¼ˆOTï¼‰</option>
            <option value="è¨€èªè´è¦šå£«">è¨€èªè´è¦šå£«ï¼ˆSTï¼‰</option>
          </select>
        </div>
        <div class="form-group">
          <label>ä½œæˆè€…æ°å</label>
          <input type="text" id="staffName" placeholder="éˆ´æœ¨ èŠ±å­">
        </div>
      </div>
    </div>
    
    <div class="card">
      <h2 class="section-title">
        <span class="icon" style="background: #f3e8ff; color: #8b5cf6;">ğŸ“·</span>
        ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆèª­å–
      </h2>
      <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event)">
      <div class="upload-zone" id="uploadZone" onclick="document.getElementById('imageInput').click()">
        <div class="upload-icon">ğŸ“¤</div>
        <p>ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’é¸æŠ</p>
        <p class="upload-hint">è¨˜éŒ²ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
      </div>
      <div class="image-preview" id="imagePreview"></div>
    </div>
    
    <div class="card">
      <h2 class="section-title">
        <span class="icon" style="background: #fef3c7; color: #d97706;">ğŸ“</span>
        æ—¥ã€…ã®è¨˜éŒ²
      </h2>
      <textarea id="inputText" placeholder=""></textarea>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="clearAll()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    
    <button class="btn btn-primary" id="generateBtn" onclick="generateReport()">
      âœ¨ å ±å‘Šæ›¸ã‚’ç”Ÿæˆ
    </button>
    
    <div class="card hidden" id="resultCard">
      <h2 class="section-title">
        <span class="icon" style="background: #dcfce7; color: #16a34a;">âœ…</span>
        ç—…çŠ¶ã®çµŒé
      </h2>
      <div class="result-box" id="resultText"></div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="copyResult()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        <button class="btn btn-notion" id="saveBtn" onclick="saveToNotion()">ğŸ“Š Notionã«ä¿å­˜</button>
      </div>
      <p class="note">â€» ç”Ÿæˆå†…å®¹ã¯å¿…ãšç¢ºèªãƒ»ä¿®æ­£ã®ä¸Šã”ä½¿ç”¨ãã ã•ã„</p>
    </div>
    
    <footer>
      <p>è¨ªå•çœ‹è­·å ±å‘Šæ›¸ä½œæˆæ”¯æ´ãƒ„ãƒ¼ãƒ« v7.0</p>
      <p>çœ‹è­·å¸«ãƒ»PTãƒ»OTãƒ»STå¯¾å¿œ</p>
    </footer>
  </div>

  <script>
    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      const now = new Date();
      const month = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
      document.getElementById('reportMonth').value = month;
      
      const savedGasUrl = localStorage.getItem('gasUrl');
      if (savedGasUrl) {
        document.getElementById('gasUrl').value = savedGasUrl;
      }
      
      updatePlaceholder();
    });
    
    let uploadedImages = [];
    
    function getGasUrl() {
      return document.getElementById('gasUrl').value || localStorage.getItem('gasUrl');
    }
    
    function toggleSettings() {
      document.getElementById('modalOverlay').classList.toggle('show');
      document.getElementById('settingsModal').classList.toggle('show');
    }
    
    function saveSettings() {
      const gasUrl = document.getElementById('gasUrl').value;
      localStorage.setItem('gasUrl', gasUrl);
    }
    
    async function testConnection() {
      const gasUrl = getGasUrl();
      if (!gasUrl) {
        document.getElementById('connectionStatus').innerHTML = '<span class="status-ng">URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>';
        return;
      }
      
      document.getElementById('connectionStatus').innerHTML = 'ãƒ†ã‚¹ãƒˆä¸­...';
      
      try {
        const response = await fetch(gasUrl, { method: 'GET' });
        if (response.ok) {
          document.getElementById('connectionStatus').innerHTML = '<span class="status-ok">âœ… æ¥ç¶šOK</span>';
        } else {
          document.getElementById('connectionStatus').innerHTML = '<span class="status-ng">âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼</span>';
        }
      } catch (err) {
        document.getElementById('connectionStatus').innerHTML = '<span class="status-ok">âœ… æ¥ç¶šOK</span>';
      }
    }
    
    function updatePlaceholder() {
      const staffType = document.getElementById('staffType').value;
      const textarea = document.getElementById('inputText');
      
      if (staffType === 'çœ‹è­·å¸«') {
        textarea.placeholder = `ä¾‹:
12/5 
é£Ÿäº‹æ‘‚å–è‰¯å¥½ã€æ°´åˆ†500mlæ‘‚å–
æ’ä¾¿ã‚ã‚Šï¼ˆæ™®é€šä¾¿ï¼‰
å¦»ã‚ˆã‚Šã€Œæœ€è¿‘å¤œé–“ã®å’³ãŒå¢—ãˆãŸã€ã¨ã®è¨´ãˆ
èƒƒã‚ã†éƒ¨ç™ºèµ¤ãªã—

12/8 
ç—°ãŒã‚‰ã¿ã‚ã‚Šã€å¸å¼•å®Ÿæ–½
å¦»ã®ä»‹è­·ç–²ã‚Œã‚ã‚Š`;
      } else {
        textarea.placeholder = `ä¾‹:
12/5
ROMè¨“ç·´å®Ÿæ–½ï¼ˆè‚©é–¢ç¯€å±ˆæ›²ï¼šå³120Â°â†’125Â°ï¼‰
æ­©è¡Œè¨“ç·´ï¼šå±‹å†…10mÃ—3å¾€å¾©ã€è»½ä»‹åŠ©
è‡ªä¸»ãƒˆãƒ¬ç¶™ç¶šã§ãã¦ã„ã‚‹

12/8
ä¸‹è‚¢ç­‹åŠ›è¨“ç·´ï¼šã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ10å›Ã—2ã‚»ãƒƒãƒˆ
éšæ®µæ˜‡é™ï¼šæ‰‹ã™ã‚Šä½¿ç”¨ã§4æ®µå¯èƒ½
ADLï¼šæ›´è¡£ã¯å£°æ›ã‘ã§è‡ªç«‹`;
      }
    }
    
    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    async function handleImageUpload(event) {
      const files = Array.from(event.target.files);
      if (files.length === 0) return;
      
      const gasUrl = getGasUrl();
      if (!gasUrl) {
        showError('è¨­å®šç”»é¢ã§GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        toggleSettings();
        return;
      }
      
      const uploadZone = document.getElementById('uploadZone');
      uploadZone.innerHTML = '<div class="extracting-spinner"></div><p style="color: #8b5cf6; font-weight: 600;">ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºä¸­...</p>';
      
      for (const file of files) {
        try {
          const base64 = await fileToBase64(file);
          const mediaType = file.type || 'image/jpeg';
          
          uploadedImages.push({
            id: Date.now() + Math.random(),
            preview: 'data:' + mediaType + ';base64,' + base64
          });
          
          // GASçµŒç”±ã§ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º
          const response = await fetch(gasUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'extract',
              imageBase64: base64,
              mediaType: mediaType
            })
          });
          
          const result = await response.json();
          
          if (result.success && result.text) {
            const textarea = document.getElementById('inputText');
            if (textarea.value.trim()) {
              textarea.value += '\n\n---\n\n' + result.text;
            } else {
              textarea.value = result.text;
            }
          } else {
            throw new Error(result.error || 'ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã«å¤±æ•—');
          }
        } catch (err) {
          showError('ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
        }
      }
      
      uploadZone.innerHTML = '<div class="upload-icon">ğŸ“¤</div><p>ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’é¸æŠ</p><p class="upload-hint">è¨˜éŒ²ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>';
      renderImagePreviews();
      event.target.value = '';
    }
    
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    function renderImagePreviews() {
      const container = document.getElementById('imagePreview');
      container.innerHTML = uploadedImages.map(img => `
        <div class="image-thumb">
          <img src="${img.preview}" alt="">
          <button class="image-thumb-remove" onclick="removeImage(${img.id})">âœ•</button>
        </div>
      `).join('');
    }
    
    function removeImage(id) {
      uploadedImages = uploadedImages.filter(img => img.id !== id);
      renderImagePreviews();
    }
    
    // å ±å‘Šæ›¸ç”Ÿæˆï¼ˆGASçµŒç”±ï¼‰
    async function generateReport() {
      const inputText = document.getElementById('inputText').value.trim();
      if (!inputText) {
        showError('æ—¥ã€…ã®è¨˜éŒ²ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const gasUrl = getGasUrl();
      if (!gasUrl) {
        showError('è¨­å®šç”»é¢ã§GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        toggleSettings();
        return;
      }
      
      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="loading-spinner"></div> ç”Ÿæˆä¸­...';
      hideAlerts();
      
      try {
        const response = await fetch(gasUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'generate',
            staffType: document.getElementById('staffType').value,
            patientName: document.getElementById('patientName').value,
            reportMonth: document.getElementById('reportMonth').value,
            rawRecords: inputText
          })
        });
        
        const result = await response.json();
        
        if (result.success && result.report) {
          document.getElementById('resultText').textContent = result.report;
          document.getElementById('resultCard').classList.remove('hidden');
          document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
        } else {
          throw new Error(result.error || 'å ±å‘Šæ›¸ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
      } catch (err) {
        showError('å ±å‘Šæ›¸ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'âœ¨ å ±å‘Šæ›¸ã‚’ç”Ÿæˆ';
      }
    }
    
    // Notionä¿å­˜ï¼ˆGASçµŒç”±ï¼‰
    async function saveToNotion() {
      const gasUrl = getGasUrl();
      if (!gasUrl) {
        showError('è¨­å®šç”»é¢ã§GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        toggleSettings();
        return;
      }
      
      const btn = document.getElementById('saveBtn');
      btn.disabled = true;
      btn.innerHTML = 'ä¿å­˜ä¸­...';
      
      try {
        const response = await fetch(gasUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'save',
            reportMonth: document.getElementById('reportMonth').value,
            patientName: document.getElementById('patientName').value,
            staffType: document.getElementById('staffType').value,
            staffName: document.getElementById('staffName').value,
            rawRecords: document.getElementById('inputText').value,
            generatedReport: document.getElementById('resultText').textContent
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSuccess('Notionã«ä¿å­˜ã—ã¾ã—ãŸï¼');
        } else {
          throw new Error(result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
      } catch (err) {
        showError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ“Š Notionã«ä¿å­˜';
      }
    }
    
    // ã‚³ãƒ”ãƒ¼
    async function copyResult() {
      try {
        await navigator.clipboard.writeText(document.getElementById('resultText').textContent);
        showSuccess('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      } catch (err) {
        const textarea = document.createElement('textarea');
        textarea.value = document.getElementById('resultText').textContent;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showSuccess('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      }
    }
    
    // ã‚¯ãƒªã‚¢
    function clearAll() {
      document.getElementById('patientName').value = '';
      document.getElementById('staffName').value = '';
      document.getElementById('inputText').value = '';
      document.getElementById('resultCard').classList.add('hidden');
      uploadedImages = [];
      renderImagePreviews();
      hideAlerts();
    }
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆ
    function showError(msg) {
      const el = document.getElementById('errorAlert');
      el.textContent = 'âš ï¸ ' + msg;
      el.classList.remove('hidden');
      el.scrollIntoView({ behavior: 'smooth' });
      setTimeout(() => el.classList.add('hidden'), 5000);
    }
    
    function showSuccess(msg) {
      const el = document.getElementById('successAlert');
      el.textContent = 'âœ… ' + msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }
    
    function hideAlerts() {
      document.getElementById('errorAlert').classList.add('hidden');
      document.getElementById('successAlert').classList.add('hidden');
    }
  </script>
</body>
</html>
